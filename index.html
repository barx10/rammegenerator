<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geometrikalkulator for motorsykkel</title>
<script type="text/javascript" src="wz_jsgraphics.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --primary: #1a1a1a;
  --accent: #ff6b00;
  --bg-light: #fafafa;
  --border: #e0e0e0;
  --shadow: rgba(0,0,0,0.08);
  --text-dark: #2c3e50;
  --text-light: #7f8c8d;

  /* Kontrollpunkt-farger (må matche prikkene) */
  --cp-wheel: #27ae60;
  --cp-steering: #3498db;
  --cp-rake: #9b59b6;
  --cp-frame-top: #1abc9c;
  --cp-frame-bottom: #e74c3c;
  --cp-frame-angle: #c0392b;
  --cp-fork: #e67e22;
  --cp-image: #f39c12;
  --cp-rotation: #8e44ad;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  margin: 0;
  padding: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
  gap: 8px;
}

h1 {
  color: var(--primary);
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
  letter-spacing: -0.5px;
  background: linear-gradient(135deg, var(--primary), #34495e);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.lang-toggle {
  display: flex;
  gap: 4px;
}

.lang-toggle button {
  padding: 6px 12px;
  cursor: pointer;
  border: 1px solid var(--border);
  background: white;
  border-radius: 6px;
  font-weight: 500;
  font-size: 0.8rem;
  transition: all 0.2s ease;
  color: var(--text-dark);
}

.lang-toggle button:hover {
  border-color: var(--accent);
}

.lang-toggle button.active {
  background: linear-gradient(135deg, var(--accent), #ff8800);
  color: white;
  border-color: var(--accent);
  box-shadow: 0 2px 8px rgba(255,107,0,0.3);
}

/* Side-by-side layout */
.main-layout {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

.inputs-panel {
  flex: 0 0 auto;
  min-width: 320px;
  max-width: 420px;
}

.canvas-panel {
  flex: 1 1 auto;
  min-width: 0;
  overflow: auto;
}

/* Kompakt tabell-styling */
table {
  width: 100%;
  border-collapse: collapse;
}

td {
  padding: 4px 4px;
  vertical-align: middle;
  color: var(--text-dark);
  font-size: 0.8rem;
  line-height: 1.3;
}

td:first-child {
  font-weight: 500;
}

/* Kompakte input-felter */
input[type="text"] {
  padding: 5px 8px;
  width: 55px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 0.8rem;
  transition: all 0.2s ease;
  background: white;
}

input[type="text"]:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(255,107,0,0.1);
}

input[readonly] {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  color: var(--text-dark);
  font-weight: 600;
  width: 50px;
}

select {
  padding: 5px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 0.8rem;
  cursor: pointer;
  background: white;
  transition: all 0.2s ease;
}

select:focus {
  outline: none;
  border-color: var(--accent);
}

hr {
  border: none;
  border-top: 1px solid var(--border);
  margin: 6px 0;
  opacity: 0.5;
}

.hint {
  color: var(--text-light);
  font-size: 0.7rem;
  font-style: italic;
  display: block;
  margin-top: 1px;
}

/* Kompakte rader */
.input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.input-group label {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-dark);
}

.input-inline {
  display: flex;
  align-items: center;
  gap: 4px;
}

.unit {
  font-size: 0.75rem;
  color: var(--text-light);
}

/* Resultat-rader styling */
.results-row td:first-child {
  color: var(--accent);
}

/* Responsiv design */
@media (max-width: 1100px) {
  .main-layout {
    flex-direction: column;
  }

  .inputs-panel {
    max-width: 100%;
    width: 100%;
  }

  .canvas-panel {
    width: 100%;
  }
}

#test {
  border: 2px solid var(--border);
  margin-top: 0;
  background: linear-gradient(to bottom, #fafafa, #ffffff);
  cursor: default;
  border-radius: 8px;
  box-shadow: inset 0 2px 8px var(--shadow);
  overflow: hidden;
}

#test.dragging {
  cursor: grabbing !important;
}

.drag-tooltip {
  position: absolute;
  background: rgba(44, 62, 80, 0.9);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  pointer-events: none;
  z-index: 1001;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.control-point-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 10px;
  margin-top: 6px;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
  font-size: 0.7rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.legend-dot[data-color="wheel"] { background: var(--cp-wheel); }
.legend-dot[data-color="steering"] { background: var(--cp-steering); }
.legend-dot[data-color="rake"] { background: var(--cp-rake); }
.legend-dot[data-color="rotation"] { background: var(--cp-rotation); }
.legend-dot[data-color="frameTop"] { background: var(--cp-frame-top); }
.legend-dot[data-color="frameBottom"] { background: var(--cp-frame-bottom); }
.legend-dot[data-color="frameAngle"] { background: var(--cp-frame-angle); }
.legend-dot[data-color="fork"] { background: var(--cp-fork); }
.legend-dot[data-color="image"] { background: var(--cp-image); }

.field-highlight { 
  background: linear-gradient(135deg, #fff3e0, #ffe0b2) !important;
  border: 2px solid var(--accent) !important;
  box-shadow: 0 0 0 3px rgba(255,107,0,0.2) !important;
  transform: scale(1.02);
}

.download-pdf-btn {
  background: linear-gradient(135deg, #27ae60, #2ecc71);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  margin: 8px 0;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(39,174,96,0.3);
}

.download-pdf-btn:hover {
  background: linear-gradient(135deg, #2ecc71, #27ae60);
  box-shadow: 0 4px 12px rgba(39,174,96,0.4);
  transform: translateY(-1px);
}

#canvas-container {
  position: relative;
  display: inline-block;
}

.resize-handle {
  position: absolute;
  width: 12px;
  height: 12px;
  background: var(--accent);
  border: 2px solid white;
  border-radius: 50%;
  cursor: nwse-resize;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  display: none;
  z-index: 1000;
}

.resize-handle.active {
  display: block;
}

.draggable-overlay {
  position: absolute;
  border: 2px dashed var(--accent);
  background: rgba(255,107,0,0.1);
  cursor: move;
  display: none;
  z-index: 999;
}

.draggable-overlay.active {
  display: block;
}

.draggable-overlay:hover {
  background: rgba(255,107,0,0.2);
}

/* Button row */
.button-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.lock-frame-btn {
  padding: 10px 20px;
  background: linear-gradient(135deg, #3498db, #2980b9);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.lock-frame-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(52,152,219,0.4);
}

.lock-frame-btn.locked {
  background: linear-gradient(135deg, #27ae60, #1e8449);
}

.lock-frame-btn.locked:hover {
  box-shadow: 0 4px 12px rgba(39,174,96,0.4);
}

.rotation-display {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 8px 15px;
  background: #f0f0f0;
  border-radius: 6px;
  font-weight: 500;
  color: var(--text-dark);
}

#rotationValue {
  font-weight: 700;
  color: var(--accent);
  min-width: 35px;
  text-align: right;
}

/* Footer / Kontakt */
.footer {
  margin-top: 30px;
  padding: 20px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 15px;
}

.footer-logo {
  height: 50px;
  width: auto;
  cursor: pointer;
  transition: opacity 0.2s ease;
}

.footer-logo:hover {
  opacity: 0.8;
}

.footer-center {
  color: var(--text-dark);
  font-size: 0.9rem;
  font-weight: 500;
}

.footer-contact {
  text-align: right;
  color: var(--text-dark);
  font-size: 0.9rem;
}

.footer-contact a {
  color: var(--accent);
  text-decoration: none;
}

.footer-contact a:hover {
  text-decoration: underline;
}
</style>
</head>
<body>

<div class="container">
<div class="header-row">
  <h1 data-no="Geometrikalkulator for motorsykkel" data-en="Motorcycle Geometry Calculator">Geometrikalkulator for motorsykkel</h1>
  <div class="lang-toggle">
    <button id="btnNo" class="active" onclick="setLang('no')">Norsk</button>
    <button id="btnEn" onclick="setLang('en')">English</button>
  </div>
</div>

<form action="#" name="form1" method="post">
<div class="main-layout">
<div class="inputs-panel">
<table>
  <tr>
    <td data-no="Gaffeltype" data-en="Fork type">Gaffeltype</td>
    <td>
      <select id="KTyyppi" name="KTyyppi" onchange="keulavaihdos();">
        <option value="T" data-no="Teleskop" data-en="Telescopic">Teleskop</option>
        <option value="S" data-no="Springer" data-en="Springer">Springer</option>
      </select>
    </td>
    <td data-no="Detaljer" data-en="Details">Detaljer</td>
    <td>
      <select name="details" onchange="calculate(0);">
        <option value="0" data-no="Nei" data-en="No">Nei</option>
        <option value="1" data-no="Ja" data-en="Yes">Ja</option>
      </select>
    </td>
  </tr>
  <tr><td colspan="4"><hr></td></tr>
  <tr>
    <td data-no="Styreaksel høyde" data-en="Steering height">Styreaksel høyde<span class="hint" data-no="(fra bakken)" data-en="(from ground)">(fra bakken)</span></td>
    <td><input id="Yep" type="text" name="Yep" value="88" onkeyup="calculate(1);"> <span class="unit">cm</span></td>
    <td data-no="Gaffellengde" data-en="Fork length">Gaffellengde<span class="hint" data-no="(T→aksel)" data-en="(T→axle)">(T→aksel)</span></td>
    <td><input id="k" type="text" name="k" value="0" onkeyup="calculate(2);"> <span class="unit">cm</span></td>
  </tr>
  <tr>
    <td data-no="Styrerør rake" data-en="Head tube rake">Styrerør rake</td>
    <td><input id="RAKEep" type="text" name="RAKEep" value="41" onkeyup="calculate(0);"> <span class="unit">°</span></td>
    <td data-no="T-stykke vinkel" data-en="Triple clamp angle">T-stykke vinkel</td>
    <td><input id="RAKEtk" type="text" name="RAKEtk" value="6" onkeyup="calculate(0);"> <span class="unit">°</span></td>
  </tr>
  <tr id="springu" style="display:none;">
    <td colspan="2" data-no="Nedre lenke (Springer)" data-en="Lower link (Springer)">Nedre lenke (Springer)</td>
    <td colspan="2"><input id="ALOffset" type="text" name="ALOffset" value="0" onkeyup="calculate(0);"> <span class="unit">cm</span></td>
  </tr>
  <tr id="hydra">
    <td colspan="2" data-no="T-stykke offset" data-en="Triple clamp offset">T-stykke offset</td>
    <td colspan="2"><input id="TKOffset" type="text" name="TKOffset" value="5" onkeyup="calculate(0);"> <span class="unit">cm</span></td>
  </tr>
  <tr><td colspan="4"><hr></td></tr>
  <tr>
    <td data-no="Forhjul diameter" data-en="Front wheel diameter">Forhjul diameter</td>
    <td><input id="Re" type="text" value="27" name="Re" onkeyup="calculate(0);"> <span class="unit">"</span></td>
    <td data-no="Bakhjul diameter" data-en="Rear wheel diameter">Bakhjul diameter</td>
    <td><input id="Rt" type="text" value="26" name="Rt" onkeyup="calculate(0);"> <span class="unit">"</span></td>
  </tr>
  <tr>
    <td data-no="Gaffelrør lengde" data-en="Fork tube length">Gaffelrør lengde</td>
    <td><input id="KPOpit" type="text" name="KPOpit" value="72" onkeyup="calculate(0);"> <span class="unit">cm</span></td>
    <td data-no="Ramme lengde" data-en="Frame length">Ramme lengde</td>
    <td><input id="RunkoL" type="text" name="RunkoL" value="115" onkeyup="calculate(0);"> <span class="unit">cm</span></td>
  </tr>
  <tr>
    <td data-no="Seteknekk" data-en="Seat kink">Seteknekk<span class="hint" data-no="(setehøyde)" data-en="(seat height)">(setehøyde)</span></td>
    <td><input id="seteH" type="text" name="seteH" value="0" onkeyup="calculate(0);"> <span class="unit">cm</span></td>
    <td data-no="Knekk posisjon" data-en="Kink position">Knekk posisjon<span class="hint" data-no="(fra bak)" data-en="(from rear)">(fra bak)</span></td>
    <td><input id="knekkPos" type="text" name="knekkPos" value="10" onkeyup="calculate(0);"> <span class="unit">%</span></td>
  </tr>
  <tr><td colspan="4"><hr></td></tr>
  <tr id="detailit">
    <td data-no="Linjetykkelse" data-en="Line width">Linjetykkelse</td>
    <td><input id="linewidth" type="text" name="linewidth" value="3" onkeyup="calculate(0);"></td>
    <td data-no="Zoom" data-en="Zoom">Zoom</td>
    <td><input id="zoom" type="text" name="zoom" value="2.5" onkeyup="calculate(0);"> <span class="unit">x</span></td>
  </tr>
  <tr id="viiva"><td colspan="4"><hr></td></tr>
  <tr>
    <td data-no="Bunnklaring" data-en="Ground clearance">Bunnklaring</td>
    <td><input id="maavara" type="text" name="maavara" value="8" onkeyup="calculate(0);"> <span class="unit">cm</span></td>
    <td data-no="Nedre ramme" data-en="Lower frame">Nedre ramme</td>
    <td><input id="alarunko" type="text" name="alarunko" value="60" onkeyup="calculate(0);"> <span class="unit">cm</span></td>
  </tr>
  <tr>
    <td data-no="Kehto hjørne" data-en="Cradle corner">Kehto hjørne</td>
    <td><input id="kehto" type="text" name="kehto" value="12" onkeyup="calculate(0);"> <span class="unit">cm</span></td>
    <td data-no="Nedre ramme vinkel" data-en="Lower frame angle">Nedre ramme vinkel</td>
    <td><input id="alarunkoAngle" type="text" name="alarunkoAngle" value="0" onkeyup="calculate(0);"> <span class="unit">°</span></td>
  </tr>
  <tr><td colspan="4"><hr></td></tr>
  <tr class="results-row">
    <td data-no="Trail" data-en="Trail">Trail</td>
    <td><input id="jatto" type="text" name="jatto" value="0" readonly> <span class="unit">cm</span></td>
    <td data-no="Akselavstand" data-en="Wheelbase">Akselavstand</td>
    <td><input id="Text9" type="text" name="av" value="" readonly> <span class="unit">cm</span></td>
  </tr>
  <tr class="results-row">
    <td data-no="Øvre rør" data-en="Upper tube">Øvre rør<span class="hint" data-no="(lengde)" data-en="(length)">(lengde)</span></td>
    <td><input id="Text10" type="text" name="yptp" value="" readonly> <span class="unit">cm</span></td>
    <td data-no="Vis beregninger" data-en="Show calcs">Vis beregninger</td>
    <td>
      <select name="calcvalues" onchange="calculate(0);">
        <option value="1" data-no="Ja" data-en="Yes">Ja</option>
        <option value="0" data-no="Nei" data-en="No">Nei</option>
      </select>
    </td>
  </tr>
  <tr><td colspan="4"><hr></td></tr>
</table>

<div class="button-row">
  <button type="button" class="lock-frame-btn" onclick="toggleFrameLock()" id="lockFrameBtn" data-no="Lås ramme" data-en="Lock frame">Lås ramme</button>
  <span id="rotationDisplay" class="rotation-display" style="display:none;">
    <span data-no="Rotasjon:" data-en="Rotation:">Rotasjon:</span>
    <span id="rotationValue">0</span>°
  </span>
  <button type="button" class="download-pdf-btn" onclick="downloadPDF()" id="downloadPdfBtn" data-no="Last ned PDF" data-en="Download PDF">Last ned PDF</button>
</div>

<div id="controlPointLegend" class="control-point-legend">
  <span style="font-weight:600; margin-right: 8px;" data-no="Dra i punktene for å justere:" data-en="Drag points to adjust:">Dra i punktene for å justere:</span>
  <div class="legend-item"><span class="legend-dot" data-color="wheel"></span><span data-no="Hjul diameter" data-en="Wheel diameter">Hjul diameter</span></div>
  <div class="legend-item"><span class="legend-dot" data-color="steering"></span><span data-no="Styrerør" data-en="Steering head">Styrerør</span></div>
  <div class="legend-item"><span class="legend-dot" data-color="rake"></span><span data-no="Rake vinkel" data-en="Rake angle">Rake vinkel</span></div>
  <div class="legend-item"><span class="legend-dot" data-color="rotation"></span><span data-no="Rammerotasjon" data-en="Frame rotation">Rammerotasjon</span></div>
  <div class="legend-item"><span class="legend-dot" data-color="frameTop"></span><span data-no="Ramme topp" data-en="Frame top">Ramme topp</span></div>
  <div class="legend-item"><span class="legend-dot" data-color="frameBottom"></span><span data-no="Ramme bunn" data-en="Frame bottom">Ramme bunn</span></div>
  <div class="legend-item"><span class="legend-dot" data-color="frameAngle"></span><span data-no="Ramme vinkel" data-en="Frame angle">Ramme vinkel</span></div>
  <div class="legend-item"><span class="legend-dot" data-color="fork"></span><span data-no="Gaffel/T-stykke" data-en="Fork/Triple clamp">Gaffel/T-stykke</span></div>
  <div class="legend-item"><span class="legend-dot" data-color="image"></span><span data-no="Motor/Tank" data-en="Engine/Tank">Motor/Tank</span></div>
</div>
</div><!-- end inputs-panel -->

<div class="canvas-panel">
<div id="canvas-container">
<div id="test" style="position:relative;left:0px;top:0px;width:900px;height:550px;z-index:2;overflow:visible;" onclick="handleCanvasClick(event)"></div>
</div>
</div><!-- end canvas-panel -->

</div><!-- end main-layout -->
</form>

<footer class="footer">
  <a href="https://www.laererliv.no/" target="_blank" rel="noopener noreferrer">
    <img src="laererliv-logo.png" alt="Lærerliv" class="footer-logo">
  </a>
  <div class="footer-center">Lærerliv © 2025</div>
  <div class="footer-contact">
    <a href="mailto:kenneth@laererliv.no">kenneth@laererliv.no</a>
  </div>
</footer>

</div>

<script type="text/javascript">
var currentLang = 'no';
var jg_doc = new jsGraphics("test"); 
var stored_laskentatapa = 1;

var stored_ALOffset = 10;
var stored_TKOffset = 5;
var stored_RAKEtk_T = 6;

// Rammelås - lagrer alle proporsjoner når låst
var frameLocked = false;
var frameRotationAngle = 0; // Rotasjonsvinkel i grader (0 = normal)
var lockedFrame = {
  baseAngle: 0  // Startvinkel ved lås
};

function toggleFrameLock() {
  var btn = document.getElementById('lockFrameBtn');
  var rotDisplay = document.getElementById('rotationDisplay');
  
  if (!frameLocked) {
    // Lås ramma - lagre startvinkel
    lockedFrame.baseAngle = frameRotationAngle;
    
    frameLocked = true;
    btn.textContent = currentLang === 'no' ? 'Lås opp' : 'Unlock';
    btn.classList.add('locked');
    rotDisplay.style.display = 'flex';
    document.getElementById('rotationValue').textContent = '0';
    
    // Deaktiver alle input-felt
    document.querySelectorAll('input[type="text"]').forEach(function(input) {
      if (!input.readOnly) {
        input.dataset.wasEnabled = 'true';
        input.disabled = true;
      }
    });
  } else {
    // Lås opp - behold rotasjonsvinkelen aktiv
    frameLocked = false;
    
    // IKKE nullstill frameRotationAngle - den skal forbli aktiv
    // slik at tegningen forblir i rotert posisjon
    
    btn.textContent = currentLang === 'no' ? 'Lås ramme' : 'Lock frame';
    btn.classList.remove('locked');
    rotDisplay.style.display = 'none';
    
    // Reaktiver input-felt
    document.querySelectorAll('input[type="text"]').forEach(function(input) {
      if (input.dataset.wasEnabled === 'true') {
        input.disabled = false;
        delete input.dataset.wasEnabled;
      }
    });
    
    // Tegn på nytt - rotasjonen er fortsatt aktiv
    calculate(0);
  }
}

// Interaktiv editor state - alltid aktiv
var editMode = true;
var draggableElements = {
  motor: { x: 0, y: 0, width: 230/3, height: 159/3, scale: 1, dragging: false, resizing: false },
  tank: { x: 0, y: 0, width: 120/3, height: 76/3, scale: 1, dragging: false, resizing: false }
};
var dragStart = { x: 0, y: 0 };
var currentElement = null;

// Geometry control points - draggbare punkter på rammen
var controlPoints = {
  // Styrerør bunn (for rake-vinkel)
  steeringHeadBottom: { x: 0, y: 0, dragging: false, label: 'Styrerør bunn', field: 'RAKEep', color: '#3498db', cursor: 'move' },

  // Rake-vinkel håndtak
  rakeHandle: { x: 0, y: 0, dragging: false, label: 'Rake vinkel', field: 'RAKEep', color: '#9b59b6', cursor: 'grab' },

  // Ramme hjørner (øvre linje)
  frameTopEnd: { x: 0, y: 0, dragging: false, label: 'Ramme lengde', field: 'RunkoL', color: '#1abc9c', cursor: 'ew-resize' },

  // Knekk på øvre rammerør (for setehøyde)
  seatKink: { x: 0, y: 0, dragging: false, label: 'Seteknekk', field: 'seteH', color: '#1abc9c', cursor: 'move' },

  // Ramme hjørner (nedre linje)
  frameLowerMid: { x: 0, y: 0, dragging: false, label: 'Nedre ramme', field: 'alarunko', color: '#e74c3c', cursor: 'ew-resize' },
  frameLowerEnd: { x: 0, y: 0, dragging: false, label: 'Kehto hjørne', field: 'kehto', color: '#e74c3c', cursor: 'move' },
  frameLowerAngle: { x: 0, y: 0, dragging: false, label: 'Nedre ramme vinkel', field: 'alarunkoAngle', color: '#c0392b', cursor: 'grab' },

  // Gaffellengde
  forkBottom: { x: 0, y: 0, dragging: false, label: 'Gaffellengde', field: 'k', color: '#e67e22', cursor: 'move' },

  // Rammerotasjon (eget punkt for å rotere hele ramma)
  frameRotation: { x: 0, y: 0, dragging: false, label: 'Rammerotasjon', field: 'RAKEep', color: '#8e44ad', cursor: 'ns-resize' },

  // Motor og tank (draggbare bilder)
  motorImage: { x: 0, y: 0, dragging: false, label: 'Motor', type: 'image', imageKey: 'motor', color: '#f39c12', cursor: 'move' },
  tankImage: { x: 0, y: 0, dragging: false, label: 'Tank', type: 'image', imageKey: 'tank', color: '#f39c12', cursor: 'move' }
};
var draggedPoint = null;
var isDragging = false;

function getCssVar(name, fallback) {
  try {
    var value = getComputedStyle(document.documentElement).getPropertyValue(name);
    value = value ? value.trim() : '';
    return value || fallback;
  } catch (e) {
    return fallback;
  }
}

// Hold legend og prikkefarger i sync (én kilde: CSS-variabler)
(function syncControlPointColorsFromCss() {
  var steering = getCssVar('--cp-steering', controlPoints.steeringHeadBottom.color);
  var rake = getCssVar('--cp-rake', controlPoints.rakeHandle.color);
  var frameTop = getCssVar('--cp-frame-top', controlPoints.frameTopEnd.color);
  var frameBottom = getCssVar('--cp-frame-bottom', controlPoints.frameLowerMid.color);
  var frameAngle = getCssVar('--cp-frame-angle', controlPoints.frameLowerAngle.color);
  var fork = getCssVar('--cp-fork', controlPoints.forkBottom.color);
  var image = getCssVar('--cp-image', controlPoints.motorImage.color);

  controlPoints.steeringHeadBottom.color = steering;

  controlPoints.rakeHandle.color = rake;

  controlPoints.frameTopEnd.color = frameTop;
  controlPoints.seatKink.color = frameTop;

  controlPoints.frameLowerMid.color = frameBottom;
  controlPoints.frameLowerEnd.color = frameBottom;

  controlPoints.frameLowerAngle.color = frameAngle;

  controlPoints.forkBottom.color = fork;

  var rotation = getCssVar('--cp-rotation', controlPoints.frameRotation.color);
  controlPoints.frameRotation.color = rotation;

  controlPoints.motorImage.color = image;
  controlPoints.tankImage.color = image;
})();

// Last draggable elementer i localStorage
function saveElementPositions() {
  localStorage.setItem('motorcycleElements', JSON.stringify(draggableElements));
}

// Hent lagrede posisjoner
function loadElementPositions() {
  var saved = localStorage.getItem('motorcycleElements');
  if (saved) {
    try {
      var loaded = JSON.parse(saved);
      draggableElements.motor = Object.assign(draggableElements.motor, loaded.motor);
      draggableElements.tank = Object.assign(draggableElements.tank, loaded.tank);
    } catch(e) {}
  }
}

function downloadPDF() {
  var btn = document.getElementById('downloadPdfBtn');
  var originalText = btn.textContent;
  btn.textContent = currentLang === 'no' ? 'Genererer...' : 'Generating...';
  btn.disabled = true;

  // Skjul kontrollpunktene midlertidig for PDF
  var wasEditMode = editMode;
  editMode = false;
  calculate(0);

  // Vent litt for at tegningen skal oppdateres
  setTimeout(function() {
    var canvas = document.getElementById('cnv');
    if (canvas) {
      var { jsPDF } = window.jspdf;
      var pdf = new jsPDF('landscape', 'mm', 'a4');

      // Legg til tittel
      var title = currentLang === 'no' ? 'Geometrikalkulator for motorsykkel' : 'Motorcycle Geometry Calculator';
      pdf.setFontSize(18);
      pdf.text(title, 15, 15);

      // Legg til parametere
      pdf.setFontSize(10);
      var y = 25;
      var params = [
        ['Rake', document.form1.RAKEep.value + '°'],
        ['T-stykke', document.form1.RAKEtk.value + '°'],
        ['Gaffellengde', document.form1.k.value + ' cm'],
        ['Styreaksel høyde', document.form1.Yep.value + ' cm'],
        ['Trail', document.form1.jatto.value + ' cm'],
        ['Akselavstand', document.form1.av.value + ' cm'],
        ['Forhjul diameter', document.form1.Re.value + '"'],
        ['Bakhjul diameter', document.form1.Rt.value + '"']
      ];

      params.forEach(function(p, i) {
        pdf.text(p[0] + ': ' + p[1], 15 + (i % 2) * 70, y + Math.floor(i / 2) * 6);
      });

      // Konverter canvas til bilde
      var imgData = canvas.toDataURL('image/png');
      var imgWidth = 250;
      var imgHeight = canvas.height * imgWidth / canvas.width;
      pdf.addImage(imgData, 'PNG', 15, 50, imgWidth, imgHeight);

      // Last ned PDF
      var filename = 'motorsykkel-geometri-' + new Date().toISOString().slice(0,10) + '.pdf';
      pdf.save(filename);
    }

    // Gjenopprett edit mode
    editMode = wasEditMode;
    calculate(0);
    btn.textContent = originalText;
    btn.disabled = false;
  }, 100);
}

function showEditOverlays() {
  calculate(0);
}

function createControlPoint(id, point) {
  var container = document.getElementById('canvas-container');
  
  // Fjern eksisterende
  var old = document.getElementById('cp-' + id);
  if (old) old.remove();
  
  // Lag control point
  var cp = document.createElement('div');
  cp.id = 'cp-' + id;
  cp.className = 'resize-handle active';
  cp.style.left = (point.x - 6) + 'px';
  cp.style.top = (point.y - 6) + 'px';
  cp.style.background = '#27ae60';
  cp.style.width = '16px';
  cp.style.height = '16px';
  cp.title = id;
  
  cp.onmousedown = function(e) {
    e.preventDefault();
    e.stopPropagation();
    draggedPoint = id;
    dragStart.x = e.clientX - point.x;
    dragStart.y = e.clientY - point.y;
    var rect = container.getBoundingClientRect();
    dragStart.offsetX = rect.left;
    dragStart.offsetY = rect.top;
  };
  
  container.appendChild(cp);
}

function createOverlay(id, elem) {
  var container = document.getElementById('canvas-container');
  
  // Fjern eksisterende
  var old = document.getElementById('overlay-' + id);
  if (old) old.remove();
  var oldHandle = document.getElementById('handle-' + id);
  if (oldHandle) oldHandle.remove();
  
  // Lag overlay
  var overlay = document.createElement('div');
  overlay.id = 'overlay-' + id;
  overlay.className = 'draggable-overlay active';
  overlay.style.left = elem.x + 'px';
  overlay.style.top = elem.y + 'px';
  overlay.style.width = (elem.width * elem.scale) + 'px';
  overlay.style.height = (elem.height * elem.scale) + 'px';
  
  overlay.onmousedown = function(e) {
    e.preventDefault();
    currentElement = id;
    draggableElements[id].dragging = true;
    dragStart.x = e.clientX - elem.x;
    dragStart.y = e.clientY - elem.y;
  };
  
  container.appendChild(overlay);
  
  // Lag resize handle
  var handle = document.createElement('div');
  handle.id = 'handle-' + id;
  handle.className = 'resize-handle active';
  handle.style.left = (elem.x + elem.width * elem.scale - 6) + 'px';
  handle.style.top = (elem.y + elem.height * elem.scale - 6) + 'px';
  
  handle.onmousedown = function(e) {
    e.preventDefault();
    e.stopPropagation();
    currentElement = id;
    draggableElements[id].resizing = true;
    dragStart.x = e.clientX;
    dragStart.y = e.clientY;
    dragStart.startScale = elem.scale;
  };
  
  container.appendChild(handle);
}

function hideEditOverlays() {
  calculate(0);
}

// Global mouse handlers - settes opp etter at canvas er opprettet
function setupCanvasEventListeners() {
  var canvas = document.getElementById('cnv');
  if (!canvas) return;

  canvas.addEventListener('mousedown', function(e) {
    if (!editMode) return;

    var rect = canvas.getBoundingClientRect();
    var mx = e.clientX - rect.left;
    var my = e.clientY - rect.top;

    // Sjekk om vi klikket på et kontrollpunkt
    var hitRadius = 24;
    for (var key in controlPoints) {
      var p = controlPoints[key];

      // Spesialhåndtering for bilder (motor/tank)
      if (p.type === 'image' && p.imageKey) {
        var img = draggableElements[p.imageKey];
        var zoom = parseFloat(document.form1.zoom.value) || 3;
        var imgW = img.width * zoom * img.scale;
        var imgH = img.height * zoom * img.scale;
        
        // Sjekk om klikk er innenfor bildets bounding box
        if (mx >= img.x && mx <= img.x + imgW && my >= img.y && my <= img.y + imgH) {
          e.preventDefault();
          e.stopPropagation();
          draggedPoint = key;
          isDragging = true;
          dragStart.x = mx - img.x;
          dragStart.y = my - img.y;
          var testDiv = document.getElementById('test');
          if (testDiv) testDiv.classList.add('dragging');
          return;
        }
      } else {
        // Normal punktsjekk
        var dx = mx - p.x;
        var dy = my - p.y;
        if (Math.sqrt(dx * dx + dy * dy) < hitRadius) {
          e.preventDefault();
          e.stopPropagation();
          draggedPoint = key;
          isDragging = true;
          var testDiv = document.getElementById('test');
          if (testDiv) testDiv.classList.add('dragging');
          // Highlight det relaterte feltet
          var cp = controlPoints[key];
          if (cp.field) {
            highlightField(cp.field);
          }
          return;
        }
      }
    }
  });

  // Scroll-hjul for å resize motor og tank
  canvas.addEventListener('wheel', function(e) {
    if (!editMode) return;

    var rect = canvas.getBoundingClientRect();
    var mx = e.clientX - rect.left;
    var my = e.clientY - rect.top;

    // Sjekk om vi er over motor eller tank
    var zoom = parseFloat(String(document.form1.zoom.value).replace(',', '.')) || 3;

    for (var key in controlPoints) {
      var p = controlPoints[key];
      if (p.type === 'image' && p.imageKey) {
        var img = draggableElements[p.imageKey];
        var imgW = img.width * zoom * img.scale;
        var imgH = img.height * zoom * img.scale;

        if (mx >= img.x && mx <= img.x + imgW && my >= img.y && my <= img.y + imgH) {
          e.preventDefault();

          // Endre scale med scroll
          var delta = e.deltaY > 0 ? -0.1 : 0.1;
          img.scale = Math.max(0.2, Math.min(3, img.scale + delta));

          saveElementPositions();
          calculate(0);
          return;
        }
      }
    }
  }, { passive: false });
}

// Sett opp mousedown på hele dokumentet for bedre responsivitet
document.addEventListener('mousedown', function(e) {
  if (!editMode) return;

  var canvas = document.getElementById('cnv');
  if (!canvas) return;

  var rect = canvas.getBoundingClientRect();
  var mx = e.clientX - rect.left;
  var my = e.clientY - rect.top;

  // Sjekk om klikket er innenfor canvas
  if (mx < 0 || my < 0 || mx > rect.width || my > rect.height) return;

  // Sjekk om vi klikket på et kontrollpunkt
  var hitRadius = 24;
  for (var key in controlPoints) {
    var p = controlPoints[key];
    var dx = mx - p.x;
    var dy = my - p.y;
    if (Math.sqrt(dx * dx + dy * dy) < hitRadius) {
      e.preventDefault();
      draggedPoint = key;
      isDragging = true;
      var testDiv = document.getElementById('test');
      if (testDiv) testDiv.classList.add('dragging');
      var cp = controlPoints[key];
      if (cp.field) {
        highlightField(cp.field);
      }
      return;
    }
  }
});

document.addEventListener('mousemove', function(e) {
  if (!editMode) return;

  var canvas = document.getElementById('cnv');
  var testDiv = document.getElementById('test');
  if (!canvas) return;

  var rect = canvas.getBoundingClientRect();
  var mx = e.clientX - rect.left;
  var my = e.clientY - rect.top;

  // Hvis vi drar et punkt
  if (draggedPoint) {
    var point = controlPoints[draggedPoint];
    
    // Spesialhåndtering for bilder
    if (point.type === 'image' && point.imageKey) {
      var img = draggableElements[point.imageKey];
      img.x = mx - dragStart.x;
      img.y = my - dragStart.y;
      saveElementPositions();
      calculate(0);
      return;
    }
    
    point.x = mx;
    point.y = my;
    isDragging = true;
    testDiv.classList.add('dragging');

    updateValuesFromGeometry(draggedPoint, point);
    calculate(0);
    return;
  }

  // Sjekk om vi hover over et kontrollpunkt (for cursor feedback)
  var hitRadius = 24;
  var hovering = false;
  for (var key in controlPoints) {
    var p = controlPoints[key];
    
    // Spesialsjekk for bilder
    if (p.type === 'image' && p.imageKey) {
      var img = draggableElements[p.imageKey];
      var zoom = parseFloat(document.form1.zoom.value) || 3;
      var imgW = img.width * zoom * img.scale;
      var imgH = img.height * zoom * img.scale;
      
      if (mx >= img.x && mx <= img.x + imgW && my >= img.y && my <= img.y + imgH) {
        hovering = true;
        testDiv.style.cursor = 'move';
        break;
      }
    } else {
      var dx = mx - p.x;
      var dy = my - p.y;
      if (Math.sqrt(dx * dx + dy * dy) < hitRadius) {
        hovering = true;
        testDiv.style.cursor = p.cursor || 'grab';
        break;
      }
    }
  }
  if (!hovering && !draggedPoint) {
    testDiv.style.cursor = 'default';
  }
});

document.addEventListener('mouseup', function(e) {
  if (draggedPoint || isDragging) {
    draggedPoint = null;
    isDragging = false;
    var testDiv = document.getElementById('test');
    if (testDiv) {
      testDiv.classList.remove('dragging');
    }
    // Fjern field highlighting etter kort pause
    setTimeout(function() {
      var highlighted = document.querySelectorAll('.highlight-field');
      highlighted.forEach(function(el) { el.classList.remove('highlight-field'); });
    }, 500);
  }
});

function updateOverlay(id) {
  var elem = draggableElements[id];
  var overlay = document.getElementById('overlay-' + id);
  var handle = document.getElementById('handle-' + id);
  
  if (overlay) {
    overlay.style.left = elem.x + 'px';
    overlay.style.top = elem.y + 'px';
    overlay.style.width = (elem.width * elem.scale) + 'px';
    overlay.style.height = (elem.height * elem.scale) + 'px';
  }
  
  if (handle) {
    handle.style.left = (elem.x + elem.width * elem.scale - 6) + 'px';
    handle.style.top = (elem.y + elem.height * elem.scale - 6) + 'px';
  }
}

// Last posisjoner ved oppstart
loadElementPositions();

// Konverter pixel-posisjon tilbake til cm-verdier
	function updateControlPointVisuals() {
		if (!editMode) return;
		
		for (let key in controlPoints) {
			let point = controlPoints[key];
			let overlay = document.getElementById('control-' + key);
			if (overlay && point.x && point.y) {
				overlay.style.left = point.x + 'px';
				overlay.style.top = point.y + 'px';
			}
		}
	}
	
function updateValuesFromGeometry(pointId, point) {
  var zoom = parseFloat(String(document.form1.zoom.value).replace(',', '.')) || 3;
  // Hjuldiameter er i tommer, konverter til radius i cm: r = d * 2.54 / 2
  var Rt = (parseFloat(String(document.form1.Rt.value).replace(',', '.')) || 26) * 2.54 / 2;
  var Re = (parseFloat(String(document.form1.Re.value).replace(',', '.')) || 27) * 2.54 / 2;
  var Yep = parseFloat(String(document.form1.Yep.value).replace(',', '.')) || 88;
  var RunkoL = parseFloat(String(document.form1.RunkoL.value).replace(',', '.')) || 115;
  var RAKEep = parseFloat(String(document.form1.RAKEep.value).replace(',', '.')) || 41;
  var TKOffset = parseFloat(String(document.form1.TKOffset.value).replace(',', '.')) || 5;

  // Beregn nollapunkt (origin) basert på gjeldende verdier
  var nollakohtaX = 20;
  var nollakohtaY = parseInt((Yep - Rt - Rt + 60) * zoom);
  if (document.form1.details.value == 1) nollakohtaY = nollakohtaY + 50 * zoom;

  var groundY = nollakohtaY + Rt * zoom + Rt * zoom;
  var rearCenterX = nollakohtaX + Rt * zoom;
  var rearCenterY = nollakohtaY + Rt * zoom;

  var steeringHeadX = nollakohtaX + Rt * zoom + RunkoL * zoom;
  var steeringHeadY = nollakohtaY + Rt * zoom + Rt * zoom - Yep * zoom;

  if (pointId === 'steeringHeadBottom') {
    // Styrerør bunn - juster rake ved å dra
    var dx = point.x - steeringHeadX;
    var dy = point.y - steeringHeadY;
    var newAngle = Math.atan2(dx, dy) * (180 / Math.PI);
    if (newAngle > 15 && newAngle < 70) {
      document.form1.RAKEep.value = twoDecimals(newAngle);
      highlightField('RAKEep');
    }
  } else if (pointId === 'rakeHandle') {
    // Rake-vinkel håndtak - bruk beregnet styrerør-posisjon
    var dx = point.x - steeringHeadX;
    var dy = steeringHeadY - point.y;
    var newAngle = Math.atan2(dx, dy) * (180 / Math.PI);
    if (newAngle < 0) newAngle = -newAngle;
    if (newAngle > 15 && newAngle < 70) {
      document.form1.RAKEep.value = twoDecimals(newAngle);
      highlightField('RAKEep');
    }
  } else if (pointId === 'frameTopEnd') {
    // Ramme topp ende - rammelengde
    var newRunkoL = (point.x - rearCenterX) / zoom;
    if (newRunkoL > 50 && newRunkoL < 200) {
      document.form1.RunkoL.value = twoDecimals(newRunkoL);
      highlightField('RunkoL');
    }
  } else if (pointId === 'seatKink') {
    // Seteknekk - både posisjon (horisontalt) og høyde (vertikalt)
    var topEndX = controlPoints.frameTopEnd.x;
    var topEndY = controlPoints.frameTopEnd.y;
    var rearTopX = rearCenterX;
    var rearTopY = rearCenterY;
    
    // Beregn t-verdi basert på horisontal posisjon (hvor langs røret)
    var totalDx = topEndX - rearTopX;
    var newT = (point.x - rearTopX) / totalDx;
    newT = Math.max(0, Math.min(1, newT));
    var newKnekkPos = newT * 100;
    
    // Beregn base Y for denne T-verdien
    var kinkBaseY = rearTopY + (topEndY - rearTopY) * newT;
    
    // seteH er forskjellen fra base
    var newSeteH = (point.y - kinkBaseY) / zoom;
    
    if (newKnekkPos >= 0 && newKnekkPos <= 100) {
      document.form1.knekkPos.value = twoDecimals(newKnekkPos);
      highlightField('knekkPos');
    }
    if (newSeteH >= -30 && newSeteH <= 60) {
      document.form1.seteH.value = twoDecimals(newSeteH);
      highlightField('seteH');
    }
  } else if (pointId === 'forkBottom') {
    // Gaffellengde - beregn ny k basert på avstand fra styrerør-posisjon
    var TKOffset = parseFloat(String(document.form1.TKOffset.value).replace(',', '.')) || 5;
    var radtodeg = Math.PI / 180;
    // Beregn T-stykke topp posisjon
    var tcX = steeringHeadX + TKOffset * zoom * Math.sin(RAKEep * radtodeg);
    var tcY = steeringHeadY - TKOffset * zoom * Math.cos(RAKEep * radtodeg);
    var dx = point.x - tcX;
    var dy = point.y - tcY;
    var newK = Math.sqrt(dx * dx + dy * dy) / zoom;
    if (newK > 30 && newK < 150) {
      document.form1.k.value = twoDecimals(newK);
      highlightField('k');
      stored_laskentatapa = 2;
    }
  } else if (pointId === 'frameLowerMid') {
    // Nedre ramme lengde - kun horisontal avstand (alarunko)
    var startX = nollakohtaX + Rt * zoom + Rt * zoom;
    var newAlarunko = (point.x - startX) / zoom;
    if (newAlarunko > 20 && newAlarunko < 120) {
      document.form1.alarunko.value = twoDecimals(newAlarunko);
      highlightField('alarunko');
    }
  } else if (pointId === 'frameLowerEnd') {
    // Kehto hjørne - diagonal fra nedre ramme ende
    var midX = controlPoints.frameLowerMid.x;
    var midY = controlPoints.frameLowerMid.y;
    var dx = point.x - midX;
    var dy = midY - point.y;
    // Bruk den minste verdien av dx og dy som kehto størrelse
    var newKehto = Math.min(Math.abs(dx), Math.abs(dy)) / zoom;
    if (newKehto > 4 && newKehto < 40) {
      document.form1.kehto.value = twoDecimals(newKehto);
      highlightField('kehto');
    }
  } else if (pointId === 'frameLowerAngle') {
    // Nedre ramme vinkel - beregn vinkel fra startpunkt til musepeker
    var maavara = parseFloat(String(document.form1.maavara.value).replace(',', '.')) || 8;
    var startX = nollakohtaX + Rt * zoom + Rt * zoom;
    var startY = groundY - maavara * zoom;
    var dx = point.x - startX;
    var dy = startY - point.y;
    // Beregn vinkel (positiv = oppover)
    var newAngle = Math.atan2(dy, dx) * (180 / Math.PI);
    // Begrens vinkel til ±20 grader
    if (newAngle >= -20 && newAngle <= 20) {
      document.form1.alarunkoAngle.value = twoDecimals(newAngle);
      highlightField('alarunkoAngle');
    }
  } else if (pointId === 'frameRotation') {
    // Rammerotasjon - roterer hele ramma rundt bakhjul-senter
    // Krever at ramma er låst først
    
    if (!frameLocked) {
      // Vis melding om at ramma må låses først
      alert(currentLang === 'no' ? 
        'Lås ramma først ved å klikke "Lås ramme"' : 
        'Lock the frame first by clicking "Lock frame"');
      return;
    }
    
    // Beregn rotasjonsvinkel basert på musepeker fra bakhjul-senter
    var mouseDx = point.x - rearCenterX;
    var mouseDy = rearCenterY - point.y; // Y er invertert
    
    // Beregn vinkel i grader (0 = horisontalt til høyre)
    var mouseAngle = Math.atan2(mouseDy, mouseDx) * (180 / Math.PI);
    
    // Begrens rotasjonsvinkelen til ±30 grader
    var newRotation = mouseAngle;
    if (newRotation < -30) newRotation = -30;
    if (newRotation > 30) newRotation = 30;
    
    // Oppdater global rotasjonsvinkel og visning
    frameRotationAngle = newRotation;
    document.getElementById('rotationValue').textContent = newRotation.toFixed(1);
    
    // Tegn på nytt med rotasjon
    calculate(0);
  }
}

function highlightField(fieldId) {
  // Fjern tidligere highlighting
  document.querySelectorAll('.field-highlight').forEach(function(el) {
    el.classList.remove('field-highlight');
  });
  // Highlight det aktive feltet
  var field = document.getElementById(fieldId);
  if (field) {
    field.classList.add('field-highlight');
  }
}
var stored_RAKEtk_S = 0;

// Håndter klikk på tegningen for å velge felt
function handleCanvasClick(event) {
  var testDiv = document.getElementById('test');
  var rect = testDiv.getBoundingClientRect();
  var x = event.clientX - rect.left;
  var y = event.clientY - rect.top;
  
  // Fjern tidligere highlighting
  document.querySelectorAll('.field-highlight').forEach(function(el) {
    el.classList.remove('field-highlight');
  });
  
  var zoom = parseNum(document.form1.zoom.value);
  var Yep = parseNum(document.form1.Yep.value);
  var Rt = parseNum(document.form1.Rt.value);
  var Re = parseNum(document.form1.Re.value);
  
  var nollakohtaX = 20;
  var nollakohtaY = parseInt((Yep - Rt - Rt + 60) * zoom);
  if (document.form1.details.value == 1) nollakohtaY = nollakohtaY + 50 * zoom;

  var RtScaled = Rt * zoom;
  var ReScaled = Re * zoom;
  
  // Sjekk hvilken del av tegningen som ble klikket
  var dx = x - (nollakohtaX + RtScaled);
  var dy = y - (nollakohtaY + RtScaled);
  var distBack = Math.sqrt(dx*dx + dy*dy);
  
  if (distBack < RtScaled + 20) {
    // Klikket på bakhjul
    document.getElementById('Rt').classList.add('field-highlight');
    document.getElementById('Rt').focus();
    document.getElementById('Rt').select();
  } else if (x > nollakohtaX + RtScaled * 2 && y < nollakohtaY + RtScaled) {
    // Klikket i området rundt forhjul/gaffer
    if (y < nollakohtaY + RtScaled * 0.5) {
      // Øvre del - Yep eller rake
      if (x < nollakohtaX + RtScaled * 4) {
        document.getElementById('RAKEep').classList.add('field-highlight');
        document.getElementById('RAKEep').focus();
        document.getElementById('RAKEep').select();
      } else {
        document.getElementById('Yep').classList.add('field-highlight');
        document.getElementById('Yep').focus();
        document.getElementById('Yep').select();
      }
    } else {
      // Nedre del - forhjul
      document.getElementById('Re').classList.add('field-highlight');
      document.getElementById('Re').focus();
      document.getElementById('Re').select();
    }
  } else if (y > nollakohtaY + RtScaled * 1.5) {
    // Nederst - akselavstand/wheelbase
    document.getElementById('RunkoL').classList.add('field-highlight');
    document.getElementById('RunkoL').focus();
    document.getElementById('RunkoL').select();
  }
}

// Språkbytte-funksjon
function setLang(lang) {
  currentLang = lang;
  document.getElementById('btnNo').className = lang === 'no' ? 'active' : '';
  document.getElementById('btnEn').className = lang === 'en' ? 'active' : '';
  
  document.querySelectorAll('[data-' + lang + ']').forEach(function(el) {
    var newText = el.getAttribute('data-' + lang);
    if (el.tagName === 'OPTION') {
      el.textContent = newText;
    } else {
      var childHint = el.querySelector('.hint');
      if (childHint) {
        var hintText = childHint.getAttribute('data-' + lang);
        var firstText = el.childNodes[0];
        if (firstText && firstText.nodeType === 3) {
          firstText.textContent = newText;
        }
        if (hintText) childHint.textContent = hintText;
      } else {
        el.innerHTML = newText;
      }
    }
  });
  calculate(0);
}

calculate(1);
setupCanvasEventListeners();

function keulavaihdos()
{
	if (document.form1.KTyyppi.value == 'T') {
		document.getElementById('hydra').style.display='';
		document.getElementById('springu').style.display='none';
		stored_ALOffset = document.form1.ALOffset.value;
		document.form1.ALOffset.value = 0;
		document.form1.TKOffset.value = stored_TKOffset;
		stored_RAKEtk_S = document.form1.RAKEtk.value;
		document.form1.RAKEtk.value = stored_RAKEtk_T;
		
	}else{
		document.getElementById('hydra').style.display='none';
		document.getElementById('springu').style.display='';
		stored_TKOffset = document.form1.TKOffset.value;
		document.form1.TKOffset.value = 0;
		document.form1.ALOffset.value = stored_ALOffset;
		stored_RAKEtk_T = document.form1.RAKEtk.value;
		document.form1.RAKEtk.value = stored_RAKEtk_S;
	}
	calculate(0);
}

function calculate(laskentatapa)
{
	if (document.form1.details.value == 0)	{
		document.getElementById('detailit').style.display='none';
		document.getElementById('viiva').style.display='none';
	}else	{
		document.getElementById('detailit').style.display='';
		document.getElementById('viiva').style.display='';
	}
	
	if (laskentatapa == 0) {
		laskentatapa = stored_laskentatapa;
	} else {
		stored_laskentatapa = laskentatapa;
	}	
	
	var radtodeg = Math.PI/180; //apumuuttuja jolla saadaan muutettua rad --> deg
	
	//Lähtöarvot
	var Yep = new Number(document.form1.Yep.value.replace(',', '.'));
	var k = new Number(document.form1.k.value.replace(',', '.'));
	// Hjuldiameter er i tommer, konverter til radius i cm: r = d * 2.54 / 2
	var Re = new Number(document.form1.Re.value.replace(',', '.')) * 2.54 / 2;
	var Rt = new Number(document.form1.Rt.value.replace(',', '.')) * 2.54 / 2;
	
	var RAKEep = new Number(document.form1.RAKEep.value.replace(',', '.'));
	var RAKEtk = new Number(document.form1.RAKEtk.value.replace(',', '.'));
	var TKOffset = new Number(document.form1.TKOffset.value.replace(',', '.'));
	var RunkoL = new Number(document.form1.RunkoL.value.replace(',', '.'));
	var KPOpit = new Number(document.form1.KPOpit.value.replace(',', '.'));
	var ALOffset = new Number(document.form1.ALOffset.value.replace(',', '.'));
	
	//kokonaiskulma
	var KokonaisRake = RAKEep + RAKEtk;
		
	//T-kappaleiden kolmion kateetit
	var Ytk = Math.sin(radtodeg*RAKEep) * TKOffset;
	var Xtk = Math.cos(radtodeg*RAKEep) * TKOffset;
				
	//keulaputkien kolmion kateetit
	if (laskentatapa == 1) {
		var Yk = Yep - Re + Ytk;
		var Xk = Math.tan(radtodeg * KokonaisRake ) * Yk;
		k = Yk / Math.cos(radtodeg * KokonaisRake );
	} else {
		var Yk = Math.cos(radtodeg * KokonaisRake ) * k;
		var Xk = Math.sin(radtodeg * KokonaisRake ) * k;
		Yep = Yk + Re - Ytk;
	}	
	
	//emäputken virtuaalikolmion x-kateetti
	var Xep = Math.tan(radtodeg * RAKEep ) * Yep;
	if (document.form1.KTyyppi.value == 'T') {
		var jatto = Xep - Xk - Xtk;
		var akselivali = Xk + Xtk + RunkoL;
	} else {
		var jatto = Xep - Xk - Xtk - ALOffset;
		var akselivali = Xk + Xtk + RunkoL + ALOffset;
	}	
	
	// Øvre rør lengde: fra bakhjul-senter til festepunkt på styrerør
	// Festepunkt er styrerør-topp + 30% ned langs styrerør (emäputkenalapistey=10cm)
	var emapAlapisteY = 10; // cm, fast verdi i tegning
	var emapAlapisteX = Math.tan(radtodeg * RAKEep) * emapAlapisteY;
	var ovreRorDx = RunkoL + emapAlapisteX * 0.3;
	var ovreRorDy = Rt - Yep + emapAlapisteY * 0.3;
	var YPpituus = Math.sqrt(ovreRorDx * ovreRorDx + ovreRorDy * ovreRorDy);
	
	
	
	document.form1.jatto.value = twoDecimals(jatto);
	if (laskentatapa == 1) {
		document.form1.k.value = twoDecimals(k);
	} else {
		document.form1.Yep.value = twoDecimals(Yep);
	}	
	document.form1.yptp.value = twoDecimals(YPpituus);
	document.form1.av.value = twoDecimals(akselivali);



	// KUVION PIIRTO
	
		
	
	var h = Yep;
	var r = Re;
	var zoom = new Number(document.form1.zoom.value.replace(',', '.'));
	var linewidth = new Number(document.form1.linewidth.value.replace(',', '.'));
	
	Rt = parseInt(Rt * zoom);
	RunkoL = parseInt(RunkoL * zoom);
	Xep = parseInt(Xep * zoom);
	Yep = parseInt(Yep * zoom);
	

	Xtk = parseInt(Xtk * zoom);
	
	Ytk = parseInt(Ytk * zoom);
	Xk = parseInt(Xk * zoom);
	Yk = parseInt(Yk * zoom);
	Re = parseInt(Re * zoom);
	ALOffset = parseInt(ALOffset * zoom);
	
	
	
	var nollakohtaX = parseInt(20);
	var nollakohtaY = parseInt(Yep-Rt-Rt+60);

	if (document.form1.details.value == 1)	{ nollakohtaY = nollakohtaY + 50*zoom }
	
	var maavaraVal = new Number(document.form1.maavara.value.replace(',', '.'));
	var alarunkoVal = new Number(document.form1.alarunko.value.replace(',', '.'));
	var kehtoVal = new Number(document.form1.kehto.value.replace(',', '.'));
	var alarunkoAngleVal = new Number(document.form1.alarunkoAngle.value.replace(',', '.'));
	var maavara = parseInt(maavaraVal*zoom);
	var alarunko = parseInt(alarunkoVal*zoom);
	var kehtoputkienalareuna = parseInt(kehtoVal*zoom);
	// Beregn vinkel-offset for nedre ramme (positiv vinkel = stiger framover)
	var alarunkoAngleRad = alarunkoAngleVal * radtodeg;
	var alarunkoRiseY = Math.sin(alarunkoAngleRad) * alarunko;
	var alarunkoRunX = Math.cos(alarunkoAngleRad) * alarunko;
	var emäputkenalapistey = parseInt(10*zoom);
	var emäputkenalapistex =  Math.tan(radtodeg * RAKEep ) * emäputkenalapistey;
	
	var TKalay = parseInt(8*zoom);
	var TKalax =  Math.tan(radtodeg * KokonaisRake ) * TKalay;
	
	var apuviivat_allemaan = parseInt(10*zoom)
	
	jg_doc.clear();
	jg_doc.setPrintable(true);
	
	// Rotasjonsfunksjon - roterer et punkt rundt bakhjul-senter
	var pivotX = nollakohtaX + Rt;
	var pivotY = nollakohtaY + Rt;
	// Rotasjon er aktiv så lenge frameRotationAngle != 0 (uavhengig av frameLocked)
	var rotAngleRad = (frameRotationAngle !== 0) ? (frameRotationAngle * Math.PI / 180) : 0;
	
	function rotatePoint(x, y, customPivotX, customPivotY, customAngle) {
		var px = (customPivotX !== undefined) ? customPivotX : pivotX;
		var py = (customPivotY !== undefined) ? customPivotY : pivotY;
		var angle = (customAngle !== undefined) ? customAngle : rotAngleRad;
		if (angle === 0) return { x: x, y: y };
		var dx = x - px;
		var dy = y - py;
		var cos = Math.cos(angle);
		var sin = Math.sin(angle);
		return {
			x: px + dx * cos + dy * sin,
			y: py - dx * sin + dy * cos
		};
	}
	
	jg_doc.setStroke(linewidth); 
	jg_doc.setColor("#a0826d");
	jg_doc.drawLine(0, nollakohtaY+Rt+Rt, nollakohtaX+Rt+RunkoL+Xep+30*zoom, nollakohtaY+Rt+Rt); // maa
	
	jg_doc.setColor("#2c3e50"); // mørk ramme-farge

	if (document.form1.details.value == 1)	{	
		var motor = draggableElements.motor;
		var motorX = motor.x || (nollakohtaX+67*zoom);
		var motorY = motor.y || (nollakohtaY+4*zoom);
		if (!motor.x) { motor.x = motorX; motor.y = motorY; }
		jg_doc.drawImage("motor.png", motorX, motorY, motor.width*zoom*motor.scale, motor.height*zoom*motor.scale);  //Motor
		
		// Oppdater motor control point
		if (!draggedPoint || draggedPoint !== 'motorImage') {
			controlPoints.motorImage.x = motorX;
			controlPoints.motorImage.y = motorY;
		}
	}
		
	jg_doc.drawEllipse(nollakohtaX, nollakohtaY, 2*Rt, 2*Rt); // takakumi (bakhjul - roterer IKKE)
  // Øvre rammerør med knekk (setehøyde) - ROTERES
  var rearTopX = nollakohtaX + Rt;
  var rearTopY = nollakohtaY + Rt;
  var topEndX = nollakohtaX + Rt + RunkoL + emäputkenalapistex * 0.3;
  var topEndY = nollakohtaY + Rt + Rt - Yep + emäputkenalapistey * 0.3;
  var knekkPosVal = parseFloat(String(document.form1.knekkPos.value).replace(',', '.')) || 10;
  knekkPosVal = Math.max(0, Math.min(100, knekkPosVal));
  var kinkT = knekkPosVal / 100;
  var kinkBaseX = rearTopX + (topEndX - rearTopX) * kinkT;
  var kinkBaseY = rearTopY + (topEndY - rearTopY) * kinkT;
  var seteH = parseFloat(String(document.form1.seteH.value).replace(',', '.')) || 0;
  seteH = Math.max(-30, Math.min(60, seteH));
  var kinkY = kinkBaseY + (seteH * zoom);
  var kinkX = kinkBaseX;
  // Tegn to segmenter med rotasjon
  var p1 = rotatePoint(rearTopX, rearTopY);
  var p2 = rotatePoint(kinkX, kinkY);
  var p3 = rotatePoint(topEndX, topEndY);
  jg_doc.drawLine(p1.x, p1.y, p2.x, p2.y);
  jg_doc.drawLine(p2.x, p2.y, p3.x, p3.y);
	
	// Oppdater control points posisjoner for alle draggbare hjørner
	if (!draggedPoint) {
		// Styrerør bunn (emäputki ende)
		controlPoints.steeringHeadBottom.x = nollakohtaX + Rt + RunkoL + emäputkenalapistex;
		controlPoints.steeringHeadBottom.y = nollakohtaY + Rt + Rt - Yep + emäputkenalapistey;

		// Styrerør topp posisjon (for beregninger, ikke et kontrollpunkt)
		var steeringHeadTopX = nollakohtaX + Rt + RunkoL;
		var steeringHeadTopY = nollakohtaY + Rt + Rt - Yep;

		// Rake-vinkel håndtak (på linjen fra styrerør oppover)
		var rakeHandleLen = 60;
		controlPoints.rakeHandle.x = steeringHeadTopX - Math.sin(RAKEep * Math.PI / 180) * rakeHandleLen;
		controlPoints.rakeHandle.y = steeringHeadTopY - Math.cos(RAKEep * Math.PI / 180) * rakeHandleLen;

		// Ramme topp ende (på rungon yläputki)
		controlPoints.frameTopEnd.x = nollakohtaX + Rt + RunkoL + emäputkenalapistex * 0.3;
		controlPoints.frameTopEnd.y = nollakohtaY + Rt + Rt - Yep + emäputkenalapistey * 0.3;

    // Seteknekk (på øvre rammerør)
    controlPoints.seatKink.x = kinkX;
    controlPoints.seatKink.y = kinkY;

		// Nedre ramme hjørner
		// Midtre hjørne på nedre ramme (alarunko slutt) - med vinkel
		controlPoints.frameLowerMid.x = nollakohtaX + Rt + Rt + alarunkoRunX;
		controlPoints.frameLowerMid.y = nollakohtaY + Rt + Rt - maavara - alarunkoRiseY;

		// Kehto hjørne (hvor nedre ramme går opp) - med vinkel
		controlPoints.frameLowerEnd.x = nollakohtaX + Rt + Rt + alarunkoRunX + kehtoputkienalareuna;
		controlPoints.frameLowerEnd.y = nollakohtaY + Rt + Rt - maavara - alarunkoRiseY - kehtoputkienalareuna;

		// Vinkel-håndtak for nedre ramme (på midten av nedre ramme-linjen)
		var angleHandleLen = 50;
		var lowerMidX = nollakohtaX + Rt + Rt + alarunkoRunX / 2;
		var lowerMidY = nollakohtaY + Rt + Rt - maavara - alarunkoRiseY / 2;
		controlPoints.frameLowerAngle.x = lowerMidX - Math.sin(alarunkoAngleRad) * angleHandleLen;
		controlPoints.frameLowerAngle.y = lowerMidY - Math.cos(alarunkoAngleRad) * angleHandleLen;

		// Gaffel bunn (ved hjulaksel)
		controlPoints.forkBottom.x = nollakohtaX + Rt + RunkoL + Xtk + Xk;
		controlPoints.forkBottom.y = nollakohtaY + Rt + Rt - Yep - Ytk + Yk;

		// Rammerotasjon-punkt (plassert på midten av øvre ramme, lett tilgjengelig)
		// Ligger på en linje fra bakhjul-senter utover
		var rotHandleLen = RunkoL * 0.6; // 60% av rammelengden
		controlPoints.frameRotation.x = nollakohtaX + Rt + rotHandleLen;
		controlPoints.frameRotation.y = nollakohtaY + Rt - 30; // Litt over bakhjul-senter
	}
	
if (document.form1.details.value == 1)	{
	var tank = draggableElements.tank;
	var tankX = tank.x || (nollakohtaX+Rt+RunkoL-45*zoom);
	var tankY = tank.y || (nollakohtaY+Rt+Rt-Yep);
	if (!tank.x) { tank.x = tankX; tank.y = tankY; }
	jg_doc.drawImage("tank.png", tankX, tankY, tank.width*zoom*tank.scale, tank.height*zoom*tank.scale);  //Tank
	
	// Oppdater tank control point
	if (!draggedPoint || draggedPoint !== 'tankImage') {
		controlPoints.tankImage.x = tankX;
		controlPoints.tankImage.y = tankY;
	}
		jg_doc.drawEllipse(nollakohtaX+Rt+RunkoL+Xtk+Xk-Re+ALOffset+7*zoom, nollakohtaY+Rt+Rt-Yep-Ytk+Yk-Re+7*zoom, 2*Re-14*zoom, 2*Re-14*zoom); // etuvanne
		jg_doc.drawEllipse(nollakohtaX+10*zoom, nollakohtaY+10*zoom, 2*Rt-20*zoom, 2*Rt-20*zoom); // takavanne
		jg_doc.setColor("#95a5a6");
		jg_doc.setStroke(linewidth+2);
		// Sissybar med rotasjon
		var sissyEnd = rotatePoint(nollakohtaX+Rt-10*zoom, nollakohtaY+Rt-100*zoom);
		jg_doc.drawLine(pivotX, pivotY, sissyEnd.x, sissyEnd.y); // sissybuari
		jg_doc.setStroke(linewidth+3);
		// Apinakiikku med rotasjon
		var ape1Start = rotatePoint(nollakohtaX+Rt+RunkoL, nollakohtaY+Rt+Rt-Yep);
		var ape1End = rotatePoint(nollakohtaX+Rt+RunkoL-15*zoom, nollakohtaY+Rt+Rt-Yep-50*zoom);
		var ape2End = rotatePoint(nollakohtaX+Rt+RunkoL-30*zoom, nollakohtaY+Rt+Rt-Yep-30*zoom);
		jg_doc.drawLine(ape1Start.x, ape1Start.y, ape1End.x, ape1End.y); // apinakiikku
		jg_doc.drawLine(ape1End.x, ape1End.y, ape2End.x, ape2End.y);
	}	
	
	jg_doc.setColor("#000000"); // musta
	jg_doc.setStroke(linewidth*2);
	// Emäputki (styrerør) - roteres med rammen
	var emaStart = rotatePoint(nollakohtaX+Rt+RunkoL, nollakohtaY+Rt+Rt-Yep);
	var emaEnd = rotatePoint(nollakohtaX+Rt+RunkoL+emäputkenalapistex, nollakohtaY+Rt+Rt-Yep+emäputkenalapistey);
	jg_doc.drawLine(emaStart.x, emaStart.y, emaEnd.x, emaEnd.y); // emäputki
	
	jg_doc.setStroke(linewidth);
	// Nedre rammelinjer med rotasjon
	
	// Punkt 1: bakre nedre ramme start (ved bakhjulssenter)
	var lower1X = nollakohtaX+Rt;
	var lower1Y = nollakohtaY+Rt;
	// Punkt 2: bakre nedre ramme ende
	var lower2X = nollakohtaX+Rt+Rt;
	var lower2Y = nollakohtaY+Rt+Rt-maavara;
	// Punkt 3: alarunko med vinkel ende
	var lower3X = nollakohtaX+Rt+Rt+alarunkoRunX;
	var lower3Y = nollakohtaY+Rt+Rt-maavara-alarunkoRiseY;
	// Punkt 4: kehtoputkien alareuna ende
	var lower4X = nollakohtaX+Rt+Rt+alarunkoRunX+kehtoputkienalareuna;
	var lower4Y = nollakohtaY+Rt+Rt-maavara-alarunkoRiseY-kehtoputkienalareuna;
	// Punkt 5: kehtoputket ende
	var lower5X = nollakohtaX+Rt+RunkoL+emäputkenalapistex*0.8;
	var lower5Y = nollakohtaY+Rt+Rt-Yep+emäputkenalapistey*0.8;
	
	// Roter alle punkter (bruker default pivot)
	var l1Rot = rotatePoint(lower1X, lower1Y);
	var l2Rot = rotatePoint(lower2X, lower2Y);
	var l3Rot = rotatePoint(lower3X, lower3Y);
	var l4Rot = rotatePoint(lower4X, lower4Y);
	var l5Rot = rotatePoint(lower5X, lower5Y);
	
	jg_doc.drawLine(l1Rot.x, l1Rot.y, l2Rot.x, l2Rot.y); // rungon taka-alarunko
	jg_doc.drawLine(l2Rot.x, l2Rot.y, l3Rot.x, l3Rot.y); // rungon taka-alarunko (med vinkel)
	jg_doc.drawLine(l3Rot.x, l3Rot.y, l4Rot.x, l4Rot.y); // kehtoputkien alareuna
	jg_doc.drawLine(l4Rot.x, l4Rot.y, l5Rot.x, l5Rot.y); // kehtoputket
	
	// Forhjul - står FAST på bakken (roterer ikke)
	// Beregn X-posisjon fra rotert styrerør, men Y er alltid på bakkenivå
	var frontWheelOrigX, frontWheelOrigY;
	if (document.form1.KTyyppi.value == 'T'){
		frontWheelOrigX = nollakohtaX+Rt+RunkoL+Xtk+Xk;
		frontWheelOrigY = nollakohtaY+Rt+Rt-Yep-Ytk+Yk;
	}else{
		frontWheelOrigX = nollakohtaX+Rt+RunkoL+Xtk+Xk+ALOffset;
		frontWheelOrigY = nollakohtaY+Rt+Rt-Yep-Ytk+Yk;
	}
	// Roter for å finne ny X-posisjon, men behold Y på bakkenivå (samme som bakhjul)
	var fwRotated = rotatePoint(frontWheelOrigX, frontWheelOrigY);
	var frontWheelCenterX = fwRotated.x;
	var frontWheelCenterY = nollakohtaY + Rt; // Samme Y som bakhjulsenter (på bakken)
	jg_doc.drawEllipse(frontWheelCenterX-Re, frontWheelCenterY-Re, 2*Re, 2*Re); // etukumi (forhjul på bakken)
	
	// Gaffel og T-stykke må koble rotert styrerør til fast forhjul
	jg_doc.setColor("#7f8c8d");
	
	if (document.form1.KTyyppi.value == 'T'){
		if (document.form1.details.value == 1)	{ jg_doc.setStroke(linewidth+4); }
		// T-stykke topp (rotert med ramme)
		var yt1 = rotatePoint(nollakohtaX+Rt+RunkoL, nollakohtaY+Rt+Rt-Yep);
		var yt2 = rotatePoint(nollakohtaX+Rt+RunkoL+Xtk, nollakohtaY+Rt+Rt-Yep-Ytk);
		jg_doc.drawLine(yt1.x, yt1.y, yt2.x, yt2.y); // ylä T-kappale
		// Ala T-kappale (rotert med ramme)
		var at1 = rotatePoint(nollakohtaX+Rt+RunkoL+emäputkenalapistex, nollakohtaY+Rt+Rt-Yep+emäputkenalapistey);
		var at2 = rotatePoint(nollakohtaX+Rt+RunkoL+Xtk+TKalax, nollakohtaY+Rt+Rt-Yep-Ytk+TKalay);
		jg_doc.drawLine(at1.x, at1.y, at2.x, at2.y); // ala T-kappale
		// Gaffelrør fra T-stykke ned til forhjul (fast på bakken)
		jg_doc.drawLine(yt2.x, yt2.y, frontWheelCenterX, frontWheelCenterY); // Keulaputket til bakken
	} else {
		if (document.form1.details.value == 1)	{ jg_doc.setStroke(linewidth+2); }
		// Springer - fra rotert punkt til fast forhjul
		var sp1 = rotatePoint(nollakohtaX+Rt+RunkoL+Xtk, nollakohtaY+Rt+Rt-Yep-Ytk);
		jg_doc.drawLine(sp1.x, sp1.y, frontWheelCenterX, frontWheelCenterY); // taempi springer
		var sp3 = rotatePoint(nollakohtaX+Rt+RunkoL+Xtk+4*zoom, nollakohtaY+Rt+Rt-Yep-Ytk);
		jg_doc.drawLine(sp3.x, sp3.y, frontWheelCenterX+4*zoom, frontWheelCenterY); // joustava springer
		// Ala T-kappale med rotasjon
		var at1s = rotatePoint(nollakohtaX+Rt+RunkoL+emäputkenalapistex, nollakohtaY+Rt+Rt-Yep+emäputkenalapistey);
		var at2s = rotatePoint(nollakohtaX+Rt+RunkoL+Xtk+TKalax+4*zoom, nollakohtaY+Rt+Rt-Yep-Ytk+TKalay);
		jg_doc.drawLine(at1s.x, at1s.y, at2s.x, at2s.y); // ala T-kappale
		// Alalinkku fra gaffelbunn til forhjul
		jg_doc.drawLine(frontWheelCenterX-ALOffset, frontWheelCenterY, frontWheelCenterX, frontWheelCenterY); // alalinkku
	}
	
	if (document.form1.calcvalues.value == 1)	{
		//Laskentatulokset
	
		jg_doc.setStroke(2); 
		jg_doc.setColor("#ff6b00");
		if (1 == 2 )
			jg_doc.drawLine(nollakohtaX+Rt+RunkoL+Xtk+Xk, nollakohtaY+Rt+Rt-Yep-Ytk+Yk, nollakohtaX+Rt+RunkoL+Xtk+Xk, nollakohtaY+Rt+Rt+apuviivat_allemaan); // etuvanteen säde alas
		else
			jg_doc.drawLine(nollakohtaX+Rt+RunkoL+Xtk+Xk+ALOffset, nollakohtaY+Rt+Rt-Yep-Ytk+Yk, nollakohtaX+Rt+RunkoL+Xtk+Xk+ALOffset, nollakohtaY+Rt+Rt+apuviivat_allemaan); // etuvanteen säde alas

		
		
		jg_doc.drawLine(nollakohtaX+Rt, nollakohtaY+Rt, nollakohtaX+Rt, nollakohtaY+Rt+Rt+apuviivat_allemaan); // takavanteen säde alas
	
		jg_doc.drawLine(nollakohtaX+Rt+RunkoL, nollakohtaY+Rt+Rt-Yep, nollakohtaX+Rt+RunkoL+Xep, nollakohtaY+Rt+Rt); // emäputken jana
		jg_doc.drawLine(nollakohtaX+Rt+RunkoL+Xep, nollakohtaY+Rt+Rt,nollakohtaX+Rt+RunkoL+Xep, nollakohtaY+Rt+Rt+apuviivat_allemaan); // emäputken janan suora alas
			
		//tekstit
		jg_doc.drawString("av = " + twoDecimals(akselivali) + " cm", RunkoL+Xep/2, nollakohtaY+Rt+Rt+apuviivat_allemaan/2); 
		if (document.form1.KTyyppi.value == 'T')
			jg_doc.drawString("j = " + twoDecimals(jatto) + " cm", nollakohtaX+Rt+RunkoL+Xtk+Xk, nollakohtaY+Rt+Rt+apuviivat_allemaan+2); 
		else
			jg_doc.drawString("j = " + twoDecimals(jatto) + " cm", nollakohtaX+Rt+RunkoL+Xtk+Xk+ALOffset, nollakohtaY+Rt+Rt+apuviivat_allemaan+2); 
				
		jg_doc.drawString("h = " + twoDecimals(h) + " cm", nollakohtaX+Rt+RunkoL+2*zoom, nollakohtaY+Rt); 
		jg_doc.drawString("k = " + twoDecimals(k) + " cm", (nollakohtaX+Rt+RunkoL+Xtk)+((nollakohtaX+Rt+RunkoL+Xtk+Xk)-(nollakohtaX+Rt+RunkoL+Xtk))/2 + 3*zoom, (nollakohtaY+Rt+Rt-Yep-Ytk)+((nollakohtaY+Rt+Rt-Yep-Ytk+Yk)-(nollakohtaY+Rt+Rt-Yep-Ytk))/2 - 8*zoom); 
		jg_doc.drawString("r = " + twoDecimals(r) + " cm", nollakohtaX+Rt+RunkoL+Xtk+Xk+2*zoom, nollakohtaY+Rt+Rt-Re*0.75); 
	
		jg_doc.drawString("a1 = " + twoDecimals(RAKEep) + "°", nollakohtaX+Rt+RunkoL-20*zoom, nollakohtaY+Rt+Rt-Yep-2*zoom); 
		jg_doc.drawString("a2 = " + twoDecimals(KokonaisRake) + "°", nollakohtaX+Rt+RunkoL+Xtk+5*zoom, nollakohtaY+Rt+Rt-Yep-Ytk-4*zoom); 	
	
		jg_doc.setColor("#bdc3c7");
		jg_doc.drawLine(nollakohtaX+Rt+RunkoL, nollakohtaY+Rt+Rt-Yep, nollakohtaX+Rt+RunkoL, nollakohtaY+Rt+Rt); // rungon korkeus
	}
	
	// Tegn kontrollpunkter hvis edit mode (etter alt annet)
	if (editMode) {
		var cpSize = 20;
		var hoverColor = "#ff6b00";

		// Tegn hjelpelinjer
		jg_doc.setStroke(2);
		jg_doc.setColor("rgba(155, 89, 182, 0.5)");

		// Beregn styrerør topp posisjon for hjelpelinjer
		var steeringTopX = nollakohtaX + Rt + RunkoL;
		var steeringTopY = nollakohtaY + Rt + Rt - Yep;

		// Hjelpelinje for rake-vinkel (fra styrerør topp til rake handle)
		jg_doc.drawLine(steeringTopX, steeringTopY,
			controlPoints.rakeHandle.x, controlPoints.rakeHandle.y);

		// Hjelpelinje fra styrerør topp til bunn
		jg_doc.setColor("rgba(52, 152, 219, 0.5)");
		jg_doc.drawLine(steeringTopX, steeringTopY,
			controlPoints.steeringHeadBottom.x, controlPoints.steeringHeadBottom.y);

		// Tegn alle kontrollpunkter med sine farger
		for (var key in controlPoints) {
			var cp = controlPoints[key];
			var color = (draggedPoint === key) ? hoverColor : cp.color;
			jg_doc.setColor(color);
			jg_doc.fillEllipse(cp.x - cpSize/2, cp.y - cpSize/2, cpSize, cpSize);

			// Hvit kant rundt prikken
			jg_doc.setColor("#ffffff");
			jg_doc.setStroke(2);
			jg_doc.drawEllipse(cp.x - cpSize/2, cp.y - cpSize/2, cpSize, cpSize);
		}

		// Tegn tooltips/labels når man drar
		if (draggedPoint) {
			var cp = controlPoints[draggedPoint];
			jg_doc.setColor("#2c3e50");
			var fieldValue = "";
			if (cp.field && document.form1[cp.field]) {
				fieldValue = document.form1[cp.field].value;
			}
			jg_doc.drawString(cp.label + (fieldValue ? ": " + fieldValue : ""), cp.x + 15, cp.y - 20);
		}

		jg_doc.setColor("#000000");
	}
	
	jg_doc.paint();
	

}

function parseNum(val) {
  return Number(String(val).replace(',', '.'));
}

function twoDecimals( formField ) {
	//return formField;
	
	var tmpInt = new String(formField);
	tmpInt = tmpInt.replace(',','.');
	var tmpInt = new Number(tmpInt);
	if (!isNaN(tmpInt)) {
		tmpInt = Math.round(tmpInt * 10);
		tmpInt = tmpInt / 10;
		tmpInt = new String(tmpInt);
		/*if (tmpInt.indexOf(',') == -1) tmpInt += ",";
		var sDecs = tmpInt.substring(tmpInt.indexOf(',') + 1, tmpInt.length);
		if (sDecs.length == 1) tmpInt = tmpInt + '0';
		if (sDecs.length < 1) tmpInt = tmpInt + '00';*/
		tmpInt = tmpInt.replace('.', ',')
		return tmpInt;
	} else return(false);
}

</script>

</BODY>
</HTML>